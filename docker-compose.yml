version: '3.9'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš€ FinanSecure: Docker Compose para Desarrollo
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ARQUITECTURA:
#
#  Navegador
#    â”‚
#    â”œâ”€â†’ localhost:80 (NGINX - Frontend SPA)
#    â”‚       â”œâ”€â†’ http://finansecure-auth:8080 (PRIVADO - Red Docker)
#    â”‚       â”‚       â””â”€â†’ postgres-auth:5432 (PRIVADO - Red Docker)
#    â”‚       â”‚
#    â”‚       â””â”€â†’ Contenido estÃ¡tico Angular
#    â”‚
#    â”œâ”€â†’ localhost:3000 (Website - Marketing/Info)
#    â”‚       â””â”€â†’ Contenido estÃ¡tico HTML/CSS/JS
#    â”‚
#    â””â”€â†’ localhost:5050 (PgAdmin - GestiÃ³n BD) [SOLO DESARROLLO]
#
# REDES:
#  - auth-network: PostgreSQL + Auth Service (aislado)
#  - backend: NGINX + Auth Service + Website + PgAdmin (comunicaciÃ³n)
#
# SEGURIDAD:
#  âœ“ NGINX (puerto 80) es el Ãºnico punto de entrada para SPA
#  âœ“ Website (puerto 3000) servido en contenedor separado
#  âœ“ Backend NO expuesto directamente (privado vÃ­a NGINX)
#  âœ“ Database NO accesible desde navegador
#  âœ“ DNS interno solo disponible entre contenedores
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

services:

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ—„ï¸  PostgreSQL: Base de datos para Auth Service (PRIVADA - Red interna)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  postgres-auth:
    image: postgres:15-alpine
    container_name: finansecure-postgres-auth
    restart: unless-stopped

    # ğŸ” CREDENCIALES
    environment:
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: ${AUTH_DB_PASSWORD:-SecureAuth2024!}
      POSTGRES_DB: finansecure_auth_db
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
      TZ: UTC

    # âš ï¸  IMPORTANTE: Puerto expuesto SOLO para desarrollo local
    # En PRODUCCIÃ“N, esto debe ser comentado o removido
    ports:
      - "${AUTH_DB_PORT:-5432}:5432"

    # ğŸ“ VOLÃšMENES: Persistencia de datos
    volumes:
      # Datos de PostgreSQL (persistencia entre reinicios)
      - auth_db_data:/var/lib/postgresql/data

      # Script de inicializaciÃ³n (corre solo si la BD estÃ¡ vacÃ­a)
      - ./init-db.sql:/docker-entrypoint-initdb.d/01-init.sql

    # ğŸ”— REDES: Aislamiento de servicios
    networks:
      # Red privada con Auth Service
      auth-network:

        # ğŸ¥ HEALTH CHECK: Monitorear estado de la BD
    # âœ… IMPORTANTE: Especificar -d para evitar "database does not exist"
    # Sin -d, pg_isready asume database=postgres o database=username
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U auth_user -d finansecure_auth_db" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # ğŸ“Š LOGGING: Centralizar logs del contenedor
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=postgres-auth"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” FinanSecure.Auth: Servicio de AutenticaciÃ³n (PRIVADO - Red interna)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  finansecure-auth:
    build:
      context: .
      dockerfile: FinanSecure.Auth/Dockerfile
    container_name: finansecure-auth
    restart: unless-stopped

    # âš ï¸  IMPORTANTE: Puerto expuesto SOLO para debugging local
    # En PRODUCCIÃ“N, esto debe ser comentado (solo accesible via NGINX)
    ports:
      - "${AUTH_SERVICE_PORT:-8080}:8080"

    # âš™ï¸  CONFIGURACIÃ“N DEL SERVICIO
    environment:
      # ASP.NET Core configuration
      ASPNETCORE_ENVIRONMENT: ${ENVIRONMENT:-Development}
      ASPNETCORE_URLS: http://+:8080

      # Base de datos (ÃšNICA FUENTE DE VERDAD)
      # âœ… EF Core lee ConnectionStrings__DefaultConnection
      # âŒ NO usar DB_HOST, DB_PORT, etc. (no son usadas por EF Core)
      ConnectionStrings__DefaultConnection: "Host=postgres-auth;Port=5432;Database=finansecure_auth_db;Username=auth_user;Password=${AUTH_DB_PASSWORD:-SecureAuth2024!};"

      # JWT (Seguridad de tokens)
      JwtSettings__SecretKey: ${JWT_SECRET_KEY:-your-super-secret-key-min-32-chars-change-in-prod}
      JwtSettings__Issuer: ${JWT_ISSUER:-FinanSecure}
      JwtSettings__Audience: ${JWT_AUDIENCE:-FinanSecure.Client}
      JwtSettings__ExpirationMinutes: ${JWT_EXPIRATION_MINUTES:-15}
      JwtSettings__RefreshTokenExpirationDays: ${JWT_REFRESH_EXPIRATION_DAYS:-7}

      # Logging y aplicaciÃ³n
      LOG_LEVEL: ${AUTH_LOG_LEVEL:-Information}
      APP_NAME: FinanSecure.Auth
      APP_VERSION: 1.0.0
      TZ: UTC

    # ğŸ”— DEPENDENCIAS: Esperar a que PostgreSQL estÃ© listo
    depends_on:
      postgres-auth:
        condition: service_healthy

    # ğŸ”— REDES: Aislamiento y comunicaciÃ³n
    networks:
      # Red privada con PostgreSQL
      auth-network: # Red compartida con NGINX

      backend:

        # ğŸ“ VOLÃšMENES: Logs y datos
    volumes:
      - auth_logs:/app/logs

    # ğŸ›ï¸  RECURSOS: Limitar CPU y memoria (best practice)
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    # ğŸ¥ HEALTH CHECK: Monitorear servicio
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # ğŸ“Š LOGGING: Centralizar logs
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=auth"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸŒ NGINX: API Gateway + SPA Server (EXPUESTO - Ãšnico punto de entrada)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #
  # RESPONSABILIDADES:
  #  âœ“ Servir contenido estÃ¡tico de Angular (SPA)
  #  âœ“ Actuar como Reverse Proxy para /api/* â†’ finansecure-auth
  #  âœ“ Manejar CORS headers
  #  âœ“ Comprimir respuestas con GZIP
  #  âœ“ Logging centralizado de peticiones
  #  âœ“ Health check para Docker
  #
  # IMPORTANTE: El navegador SOLO accede a localhost:80
  #             Backend (finansecure-auth) es PRIVADO (no expuesto)
  #
  finansecure-frontend:
    build:
      context: .
      dockerfile: finansecure-web/Dockerfile.prod
    container_name: finansecure-frontend
    restart: unless-stopped

    # âœ… ÃšNICA ENTRADA EXPUESTA AL NAVEGADOR
    ports:
      - "${FRONTEND_PORT:-80}:80"

    # ğŸ”— DEPENDENCIAS: Esperar a que Auth Service estÃ© listo
    depends_on:
      finansecure-auth:
        condition: service_healthy
      postgres-auth:
        condition: service_healthy

    # ğŸ”— REDES: ComunicaciÃ³n con backend (red privada)
    networks:
      backend:

        # ğŸ¥ HEALTH CHECK: Monitorear disponibilidad de NGINX
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    # ğŸ“Š LOGGING: Centralizar logs de NGINX
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        labels: "service=frontend"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸŒ WEBSITE: Sitio estÃ¡tico de marketing/informaciÃ³n
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #
  # Sitio web informativo sobre FinanSecure
  # Servido en puerto separado (3000) para desarrollo local
  # En producciÃ³n, puede estar en dominio separado o ser parte de NGINX
  #
  finansecure-website:
    image: nginx:alpine
    container_name: finansecure-website
    restart: unless-stopped

    # ğŸŒ PUERTO DE ACCESO
    ports:
      - "${WEBSITE_PORT:-3000}:80"

    # ğŸ“ VOLÃšMENES: Archivos HTML/CSS/JS
    # En DESARROLLO: sin :ro para permitir hot-reload de cambios
    # En PRODUCCIÃ“N: comentar esta lÃ­nea y usar build con Dockerfile
    volumes:
      - ./website:/usr/share/nginx/html

    # ğŸ”— REDES: Accesible desde navegador
    networks:
      - backend

    # ğŸ¥ HEALTH CHECK
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # ğŸ“Š LOGGING
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
        labels: "service=website"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“Š PGADMIN: Gestor de Bases de Datos (OPCIONAL - Solo desarrollo)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #
  # Para acceder:
  #  1. Abrir navegador en http://localhost:5050
  #  2. Email: admin@finansecure.com
  #  3. Password: AdminPassword2024!
  #  4. Agregar conexiÃ³n a postgres-auth:5432
  #
  # âš ï¸  NO incluir en producciÃ³n
  #
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: finansecure-pgadmin
    restart: unless-stopped

    # ğŸ” CREDENCIALES (cambiar en producciÃ³n)
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@finansecure.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-AdminPassword2024!}
      PGADMIN_CONFIG_SERVER_MODE: "False"
      TZ: UTC

    # ğŸŒ PUERTO (solo para desarrollo)
    ports:
      - "${PGADMIN_PORT:-5050}:80"

    # ğŸ“ VOLÃšMENES (persistencia de configuraciÃ³n)
    volumes:
      - pgadmin_data:/var/lib/pgadmin

    # ğŸ”— REDES (acceso a BD)
    networks:
      - auth-network
      - backend

    # ğŸ”— DEPENDENCIAS
    depends_on:
      postgres-auth:
        condition: service_healthy

    # ğŸ¥ HEALTH CHECK
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/misc/ping" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # ğŸ“Š LOGGING
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
        labels: "service=pgadmin"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ VOLÃšMENES: Persistencia de datos entre reinicios
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
volumes:
  # ğŸ—„ï¸  Base de datos de Auth Service
  #     - Persiste entre reinicios de contenedores
  #     - Inicializado con init-db.sql
  auth_db_data:
    driver: local

  # ğŸ“Š Logs de Auth Service
  #    - Para debugging y auditorÃ­a
  auth_logs:
    driver: local

  # ğŸ“Š PgAdmin configuration
  #    - Guarda conexiones y preferencias
  pgadmin_data:
    driver: local

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”— REDES: Aislamiento y segregaciÃ³n de trÃ¡fico (Zero Trust)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Beneficios de segregaciÃ³n con mÃºltiples redes:
#  1. SEGURIDAD: Los servicios solo ven lo que necesitan
#  2. ESCALABILIDAD: FÃ¡cil agregar mÃ¡s servicios sin conflictos
#  3. ISOLATION: Breach en un servicio no compromete otros
#  4. PERFORMANCE: Menos latencia con microservicios en redes cercanas
#
networks:
  # ğŸ” RED PRIVADA: PostgreSQL + Auth Service (aislado)
  #    - SOLO acceso entre auth_service y postgres_auth
  #    - NADIE mÃ¡s puede conectar a la BD directamente
  #    - NGINX NO estÃ¡ en esta red (seguridad)
  auth-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-auth

  # ğŸŒ RED COMPARTIDA: NGINX + Backends (comunicaciÃ³n)
  #    - NGINX puede comunicarse con Auth Service
  #    - Usado para rutas de API Gateway
  #    - Servicios que entran por NGINX
  backend:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-backend
