#!/bin/bash

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ SECURITY-CHECK - Validaciรณn de seguridad pre-deployment
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
#
# USO:
#   ./security-check.sh
#
# VALIDA:
#   โ No hay secretos hardcodeados en appsettings.json
#   โ .env estรก en .gitignore
#   โ No hay contraseรฑas en docker-compose.yml
#   โ .env.template existe
#   โ .dockerignore existe
#   โ No hay secretos en logs de Docker
#
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo ""
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}๐ FinanSecure - Pre-Deployment Security Check${NC}"
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

ERRORS=0
WARNINGS=0

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 1: Secretos en appsettings.json
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "1๏ธโฃ  Checking appsettings.json for hardcoded secrets..."

if grep -i "Password" FinanSecure.Auth/appsettings.json | grep -v "null" | grep -v "CHANGE_ME" > /dev/null 2>&1; then
    echo -e "${RED}   โ FAIL: Secretos encontrados en appsettings.json${NC}"
    grep -n "Password" FinanSecure.Auth/appsettings.json | grep -v "null" | grep -v "CHANGE_ME"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}   โ PASS: No hay secretos hardcodeados${NC}"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 2: .env en .gitignore
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "2๏ธโฃ  Checking .gitignore for .env..."

if grep -q "^\.env$" .gitignore; then
    echo -e "${GREEN}   โ PASS: .env estรก en .gitignore${NC}"
else
    echo -e "${RED}   โ FAIL: .env NO estรก en .gitignore${NC}"
    ERRORS=$((ERRORS + 1))
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 3: Fallbacks inseguros en docker-compose.yml
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "3๏ธโฃ  Checking docker-compose.yml for hardcoded secrets..."

if grep -E "SecureAuth2024|your-super-secret" docker-compose.yml | grep -v "\${" > /dev/null 2>&1; then
    echo -e "${RED}   โ FAIL: Hardcoded secrets en docker-compose.yml${NC}"
    grep -n "SecureAuth2024\|your-super-secret" docker-compose.yml | grep -v "\${"
    ERRORS=$((ERRORS + 1))
elif grep -E "\$\{[A-Z_]+:-[a-zA-Z0-9]+\}" docker-compose.yml > /dev/null 2>&1; then
    echo -e "${YELLOW}   โ๏ธ  WARNING: Fallbacks en variables de entorno detectados${NC}"
    echo "      (Recomendado usar valores CHANGE_ME en lugar de funcionales)"
    grep -n "\${\|:-" docker-compose.yml | head -3
    WARNINGS=$((WARNINGS + 1))
else
    echo -e "${GREEN}   โ PASS: No hay hardcoded secrets${NC}"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 4: Archivos template existen
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "4๏ธโฃ  Checking for .env.template..."

if [ -f .env.template ]; then
    echo -e "${GREEN}   โ PASS: .env.template existe${NC}"
else
    echo -e "${RED}   โ FAIL: .env.template no encontrado${NC}"
    ERRORS=$((ERRORS + 1))
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 5: .dockerignore existe
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "5๏ธโฃ  Checking for .dockerignore..."

if [ -f .dockerignore ]; then
    echo -e "${GREEN}   โ PASS: .dockerignore existe${NC}"
    
    # Verificar que excluye secretos
    if grep -q "\.env" .dockerignore; then
        echo "      โโ Excluye .env โ"
    else
        echo -e "${YELLOW}      โโ WARNING: .env no estรก en .dockerignore${NC}"
        WARNINGS=$((WARNINGS + 1))
    fi
else
    echo -e "${RED}   โ FAIL: .dockerignore no encontrado${NC}"
    ERRORS=$((ERRORS + 1))
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 6: Validar permisos de .env (si existe)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "6๏ธโฃ  Checking .env permissions..."

if [ -f .env ]; then
    PERMS=$(stat -f%OLp .env 2>/dev/null || stat -c %a .env 2>/dev/null || echo "unknown")
    
    if [ "$PERMS" = "600" ] || [ "$PERMS" = "unknown" ]; then
        echo -e "${GREEN}   โ PASS: .env tiene permisos restrictivos (600)${NC}"
    else
        echo -e "${YELLOW}   โ๏ธ  WARNING: Permisos de .env son $PERMS (se recomienda 600)${NC}"
        echo "      Ejecutar: chmod 600 .env"
        WARNINGS=$((WARNINGS + 1))
    fi
else
    echo -e "${YELLOW}   โน๏ธ  .env no existe (crear con generate-secrets.sh)${NC}"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 7: Validar Git history (buscar secretos comprometidos)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "7๏ธโฃ  Checking Git history for secrets..."

if git log --all -S "SecureAuth2024" --format="%h %s" 2>/dev/null | head -1 > /dev/null 2>&1; then
    echo -e "${YELLOW}   โ๏ธ  WARNING: SecureAuth2024 encontrado en historial de Git${NC}"
    echo "      Si fue cometido, ejecutar: bfg --delete-files appsettings.json"
    WARNINGS=$((WARNINGS + 1))
else
    echo -e "${GREEN}   โ PASS: No hay secretos en historial de Git${NC}"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# RESUMEN
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"

if [ $ERRORS -eq 0 ]; then
    echo -e "${GREEN}โ SECURITY CHECK PASSED${NC}"
    if [ $WARNINGS -gt 0 ]; then
        echo -e "${YELLOW}โ๏ธ  $WARNINGS warnings encontrados (ver arriba)${NC}"
    fi
    echo ""
    echo -e "${GREEN}โ Listo para CI/CD deployment${NC}"
    echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}โ $ERRORS CRITICAL ERRORS FOUND${NC}"
    if [ $WARNINGS -gt 0 ]; then
        echo -e "${YELLOW}โ๏ธ  $WARNINGS warnings${NC}"
    fi
    echo ""
    echo -e "${RED}โ NO permitir deployment hasta resolver todos los errores${NC}"
    echo -e "${RED}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    exit 1
fi
