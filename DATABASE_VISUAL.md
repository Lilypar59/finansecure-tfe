# ğŸ¨ Diagrama Visual - FinanSecure Database Architecture

VisualizaciÃ³n completa de la arquitectura de microservicios.

---

## ğŸ“Š Arquitectura General del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          FinanSecure Platform                            â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    API Gateway (Port 80/443)                        â”‚ â”‚
â”‚  â”‚  â”œâ”€ Route: /auth/*        â†’ Auth Service (Port 5001)              â”‚ â”‚
â”‚  â”‚  â”œâ”€ Route: /transactions/* â†’ Transactions Service (Port 5002)    â”‚ â”‚
â”‚  â”‚  â””â”€ Route: /budgets/*     â†’ Transactions Service (Port 5002)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      JWT Authentication                             â”‚ â”‚
â”‚  â”‚  Header: Authorization: Bearer eyJhbGciOiJIUzI1NiIs...           â”‚ â”‚
â”‚  â”‚  Payload: {sub: "user-uuid", iss: "FinanSecure", exp: ...}       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Auth Service       â”‚                â”‚  Transactions Service       â”‚ â”‚
â”‚  â”‚  Port: 5001         â”‚                â”‚  Port: 5002                 â”‚ â”‚
â”‚  â”‚  â”œâ”€ /login          â”‚                â”‚  â”œâ”€ /transactions           â”‚ â”‚
â”‚  â”‚  â”œâ”€ /register       â”‚                â”‚  â”œâ”€ /categories             â”‚ â”‚
â”‚  â”‚  â”œâ”€ /refresh        â”‚                â”‚  â”œâ”€ /budgets                â”‚ â”‚
â”‚  â”‚  â””â”€ /logout         â”‚                â”‚  â””â”€ /reports               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â†“                                            â†“                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  PostgreSQL BD      â”‚                â”‚  PostgreSQL BD              â”‚ â”‚
â”‚  â”‚  Name: auth_db_dev  â”‚                â”‚  Name: transactions_db_dev  â”‚ â”‚
â”‚  â”‚  Port: 5432         â”‚                â”‚  Port: 5432 (shared)        â”‚ â”‚
â”‚  â”‚  Schema: auth       â”‚                â”‚  Schema: transactions       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ Auth Service Database

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  finansecure_auth_db_dev                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  Schema: auth                                                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                                                          â”‚ â”‚
â”‚  â”‚  TABLE: users (11 columns)                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ id (UUID, PK)  â”€â”€â”€â”€â”                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ username (UNIQUE)  â”‚                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ email (UNIQUE)     â”‚                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ password_hash      â”‚                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ is_active          â”‚                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ email_verified     â”‚â”€â”€â†’ (Indexes: 5)            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ first_name         â”‚    â”œâ”€ idx_username         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ last_name          â”‚    â”œâ”€ idx_email            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ last_login_at      â”‚    â”œâ”€ idx_is_active        â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ created_at         â”‚    â”œâ”€ idx_created_at       â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ updated_at         â”‚    â””â”€ idx_last_login_at    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ deleted_at (soft delete)                        â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                          â”‚ â”‚
â”‚  â”‚  â†“ One-to-Many                                         â”‚ â”‚
â”‚  â”‚                                                          â”‚ â”‚
â”‚  â”‚  TABLE: refresh_tokens (8 columns)                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ id (UUID, PK)                                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ user_id (UUID, NO FK)  â”€â”€â”€â”€â”                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ token_value (UNIQUE)       â”‚                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ expires_at                 â”‚â”€â”€â†’ (Indexes: 4)   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ revoked_at (NULL = valid)  â”‚    â”œâ”€ idx_user_id â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ created_at                 â”‚    â”œâ”€ idx_token   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ ip_address                 â”‚    â”œâ”€ idx_expires â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ user_agent                 â”‚    â””â”€ idx_user_cr â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                          â”‚ â”‚
â”‚  â”‚  VIEWS: 2                                              â”‚ â”‚
â”‚  â”‚  â”œâ”€ active_users (active + non-deleted users)         â”‚ â”‚
â”‚  â”‚  â””â”€ active_sessions (valid tokens)                    â”‚ â”‚
â”‚  â”‚                                                          â”‚ â”‚
â”‚  â”‚  FUNCTIONS: 2                                          â”‚ â”‚
â”‚  â”‚  â”œâ”€ cleanup_expired_refresh_tokens()                  â”‚ â”‚
â”‚  â”‚  â””â”€ cleanup_deleted_users()                           â”‚ â”‚
â”‚  â”‚                                                          â”‚ â”‚
â”‚  â”‚  TRIGGERS: 1                                           â”‚ â”‚
â”‚  â”‚  â””â”€ tr_refresh_tokens_update_last_login               â”‚ â”‚
â”‚  â”‚     (Update users.last_login_at on new token)         â”‚ â”‚
â”‚  â”‚                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                â”‚
â”‚  Total: 2 tables, 9 indexes, 2 views, 2 functions, 1 trigger  â”‚
â”‚  Size: ~600 MB (+ 900 MB indexing overhead)                   â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’° Transactions Service Database

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               finansecure_transactions_db_dev                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  Schema: transactions                                               â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  ENUM TYPES: 3                                                â”‚ â”‚
â”‚  â”‚  â”œâ”€ transaction_type: INCOME | EXPENSE | TRANSFER | ...      â”‚ â”‚
â”‚  â”‚  â”œâ”€ transaction_status: PENDING | COMPLETED | CANCELLED | ... â”‚ â”‚
â”‚  â”‚  â””â”€ audit_action: CREATE | UPDATE | DELETE | ...            â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  TABLE: categories (9 columns)                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ id (UUID, PK)                                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ user_id (UUID) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ name                     â”‚â”€â”€â†’ (Indexes: 3)              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ description              â”‚    â”œâ”€ idx_user_id            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ color (hex)              â”‚    â”œâ”€ idx_user_name (UNIQUE) â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ icon                     â”‚    â””â”€ idx_is_active          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ is_active                â”‚                               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ created_at, updated_at   â”‚                               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ deleted_at (soft delete) â”‚                               â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  â†“ References                                                 â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  TABLE: transactions (13 columns)              â”Œâ”€ PRIMARY     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ id (UUID, PK)                            â”‚  â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ user_id (UUID) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ category_id (UUID FK)                  â”‚ â”‚  â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ type (ENUM) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¼â”€â”€â”¤              â”‚ â”‚
â”‚  â”‚  â”‚ amount (DECIMAL 12,2) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ description                        â”‚  â”‚ â”‚  â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ transaction_date â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ â”‚  â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ status (ENUM)  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚  â”‚ â”‚  â”‚              â”‚ â”‚
â”‚  â”‚  â”‚ reference_number           â”‚  â”Œâ”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”¼â”€â”€â”¤ Indexes: 7  â”‚ â”‚
â”‚  â”‚  â”‚ created_at, updated_at     â”‚  â”‚          â”‚  â”‚ â”œâ”€ user_id  â”‚ â”‚
â”‚  â”‚  â”‚ deleted_at (soft delete)   â”‚  â”‚          â”‚  â”‚ â”œâ”€ user_dateâ”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”œâ”€ cat_id   â”‚ â”‚
â”‚  â”‚                                                  â”‚ â”œâ”€ type     â”‚ â”‚
â”‚  â”‚  â†“ Audited by                                   â”‚ â”œâ”€ status   â”‚ â”‚
â”‚  â”‚                                                  â”‚ â”œâ”€ ref      â”‚ â”‚
â”‚  â”‚  TABLE: audit_logs (9 columns) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜ â””â”€ amount    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                  â”‚ â”‚
â”‚  â”‚  â”‚ id (UUID, PK)                        â”‚  â”‚                  â”‚ â”‚
â”‚  â”‚  â”‚ user_id (UUID)                       â”‚  â”‚                  â”‚ â”‚
â”‚  â”‚  â”‚ transaction_id (UUID) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚ Indexes: 5       â”‚ â”‚
â”‚  â”‚  â”‚ action (ENUM)                        â”‚  â”‚ â”œâ”€ user_id       â”‚ â”‚
â”‚  â”‚  â”‚ old_values (JSONB) â”€â”€â”€â”€â”            â”‚  â”‚ â”œâ”€ trans_id      â”‚ â”‚
â”‚  â”‚  â”‚ new_values (JSONB) â”€â”€â”€â”€â”¼â”€ IMMUTABLE â”‚  â”‚ â”œâ”€ action        â”‚ â”‚
â”‚  â”‚  â”‚ changed_fields (TEXT[])â”‚ (INSERT ONLY)â”‚ â”œâ”€ created_at    â”‚ â”‚
â”‚  â”‚  â”‚ ip_address, user_agent â”‚            â”‚  â”‚ â””â”€ user_created  â”‚ â”‚
â”‚  â”‚  â”‚ created_at             â”‚            â”‚  â”‚                  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                  â”‚ â”‚
â”‚  â”‚                                             â”‚                  â”‚ â”‚
â”‚  â”‚  TABLE: budgets (8 columns) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ id (UUID, PK)                                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ user_id (UUID) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ category_id (UUID FK)    â”‚â”€â”€â†’ (Indexes: 2)            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ limit_amount             â”‚    â”œâ”€ user_month_category   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ alert_percentage         â”‚    â”‚   (UNIQUE)             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ month (1-12)             â”‚    â””â”€ user_month_year       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ year                     â”‚                              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ created_at, updated_at   â”‚                              â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  VIEWS: 2                                                      â”‚ â”‚
â”‚  â”‚  â”œâ”€ transaction_summary: Monthly summaries by type/status     â”‚ â”‚
â”‚  â”‚  â””â”€ budget_status: Current budget vs spending                 â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  FUNCTIONS: 4                                                  â”‚ â”‚
â”‚  â”‚  â”œâ”€ create_audit_log(): Create audit entry                   â”‚ â”‚
â”‚  â”‚  â”œâ”€ cleanup_old_audit_logs(): 7-year retention               â”‚ â”‚
â”‚  â”‚  â”œâ”€ get_user_balance_summary(): Income-Expenses-Balance      â”‚ â”‚
â”‚  â”‚  â””â”€ update_updated_at(): Timestamp helper                    â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  TRIGGERS: 5                                                   â”‚ â”‚
â”‚  â”‚  â”œâ”€ tr_transactions_audit_insert: Auto-audit on CREATE       â”‚ â”‚
â”‚  â”‚  â”œâ”€ tr_transactions_audit_update: Auto-audit on UPDATE       â”‚ â”‚
â”‚  â”‚  â”œâ”€ tr_categories_update_timestamp: Update timestamp         â”‚ â”‚
â”‚  â”‚  â”œâ”€ tr_transactions_update_timestamp: Update timestamp       â”‚ â”‚
â”‚  â”‚  â””â”€ tr_budgets_update_timestamp: Update timestamp            â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                       â”‚
â”‚  Total: 4 tables, 14 indexes, 2 views, 4 functions, 5 triggers      â”‚
â”‚  Size: ~1,200 MB (+ 1,500 MB indexing overhead)                     â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Aislamiento de Datos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Usuario A (UUID: 550e8400-...)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  LOGIN                                                      â”‚
â”‚  â”œâ”€ auth.users (username = 'alice')                        â”‚
â”‚  â”‚  â””â”€ Validar password_hash                              â”‚
â”‚  â”‚                                                          â”‚
â”‚  â””â”€ auth.refresh_tokens INSERT                            â”‚
â”‚     â””â”€ token_value = "eyJ..."                             â”‚
â”‚        user_id = "550e8400-..."                           â”‚
â”‚                                                            â”‚
â”‚  JWT Response                                             â”‚
â”‚  â”œâ”€ access_token: eyJhbGciOiJIUzI1NiJ9...              â”‚
â”‚  â”‚  {                                                     â”‚
â”‚  â”‚   "sub": "550e8400-...",  â† UserId                   â”‚
â”‚  â”‚   "iat": 1705779600,                                 â”‚
â”‚  â”‚   "exp": 1705866000,                                 â”‚
â”‚  â”‚   "iss": "FinanSecure"                               â”‚
â”‚  â”‚  }                                                     â”‚
â”‚  â””â”€ refresh_token: "eyJ..."                              â”‚
â”‚                                                            â”‚
â”‚  API Request (with JWT)                                  â”‚
â”‚  â”œâ”€ GET /transactions                                    â”‚
â”‚  â”‚  Header: Authorization: Bearer eyJ...                â”‚
â”‚  â”‚                                                        â”‚
â”‚  â””â”€ Backend Extracts:                                    â”‚
â”‚     userId = JWT.sub  â† NEVER from body/query          â”‚
â”‚     = "550e8400-..."                                    â”‚
â”‚                                                            â”‚
â”‚  Database Query (PROTECTED)                             â”‚
â”‚  â”œâ”€ SELECT * FROM transactions.transactions            â”‚
â”‚  â”‚  WHERE user_id = '550e8400-...'  â† FORCED FILTER    â”‚
â”‚  â”‚    AND deleted_at IS NULL                            â”‚
â”‚  â”‚                                                        â”‚
â”‚  â””â”€ Result: ONLY Alice's transactions                   â”‚
â”‚     â”œâ”€ Transaction #1                                    â”‚
â”‚     â”œâ”€ Transaction #2                                    â”‚
â”‚     â”œâ”€ Transaction #3                                    â”‚
â”‚     â””â”€ ...                                               â”‚
â”‚                                                            â”‚
â”‚  âœ… GARANTIZADO: Alice solo ve sus datos                â”‚
â”‚     âŒ IMPOSIBLE: Ver datos de Bob o Carlos             â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Ãndices EstratÃ©gicos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ÃNDICES - PERFORMANCE OPTIMIZATION               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  AUTH SERVICE (9 Ãndices)                                     â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€ LOGIN PERFORMANCE                                         â”‚
â”‚  â”‚  idx_users_username       â””â”€ O(log N) lookup              â”‚
â”‚  â”‚  idx_users_email          â””â”€ O(log N) lookup              â”‚
â”‚  â”‚                                                             â”‚
â”‚  â”œâ”€ SESSION MANAGEMENT                                        â”‚
â”‚  â”‚  idx_refresh_tokens_user_id    â””â”€ Find user's tokens     â”‚
â”‚  â”‚  idx_refresh_tokens_token_value â””â”€ Validate token        â”‚
â”‚  â”‚  idx_refresh_tokens_expires_at  â””â”€ Find expired tokens   â”‚
â”‚  â”‚  idx_refresh_tokens_user_created â””â”€ Order by creation    â”‚
â”‚  â”‚                                                             â”‚
â”‚  â””â”€ MAINTENANCE                                               â”‚
â”‚     idx_users_is_active      â””â”€ Find active accounts         â”‚
â”‚     idx_users_created_at     â””â”€ Timeline queries             â”‚
â”‚     idx_users_last_login_at  â””â”€ Activity tracking            â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                 â”‚
â”‚  TRANSACTIONS SERVICE (14 Ãndices)                            â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€ CRITICAL: USER ISOLATION                                 â”‚
â”‚  â”‚  idx_transactions_user_id      â””â”€ WHERE user_id = ? (MUST HAVE)
â”‚  â”‚  idx_transactions_user_date    â””â”€ WHERE user_id + date range
â”‚  â”‚                                    â†“ Composite index = fast
â”‚  â”‚                                    â”œâ”€ Soporta: WHERE user_id = ?
â”‚  â”‚                                    â”œâ”€ Soporta: WHERE user_id + date >
â”‚  â”‚                                    â””â”€ Soporta: WHERE user_id + BETWEEN
â”‚  â”‚                                                             â”‚
â”‚  â”œâ”€ CATEGORIZATION                                           â”‚
â”‚  â”‚  idx_transactions_category_id  â””â”€ By expense type        â”‚
â”‚  â”‚  idx_transactions_type         â””â”€ Income vs Expense      â”‚
â”‚  â”‚  idx_transactions_status       â””â”€ Pending vs Completed   â”‚
â”‚  â”‚                                                             â”‚
â”‚  â”œâ”€ AUDIT TRAIL                                              â”‚
â”‚  â”‚  idx_audit_logs_user_id        â””â”€ All user changes       â”‚
â”‚  â”‚  idx_audit_logs_transaction_id â””â”€ History of transaction â”‚
â”‚  â”‚  idx_audit_logs_action         â””â”€ Filter by action type  â”‚
â”‚  â”‚  idx_audit_logs_created_at     â””â”€ Timeline queries       â”‚
â”‚  â”‚  idx_audit_logs_user_created   â””â”€ Compound (user, date)  â”‚
â”‚  â”‚                                                             â”‚
â”‚  â”œâ”€ BUDGET TRACKING                                          â”‚
â”‚  â”‚  idx_budgets_user_month        â””â”€ Current month check    â”‚
â”‚  â”‚                                                             â”‚
â”‚  â””â”€ JSONB SEARCHES (2 GIN indices)                           â”‚
â”‚     idx_audit_logs_new_values_gin â””â”€ WHERE new_values @> ... â”‚
â”‚     idx_audit_logs_old_values_gin â””â”€ WHERE old_values @> ... â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                 â”‚
â”‚  EJEMPLO: Transacciones del usuario (Enero 2025)            â”‚
â”‚                                                                 â”‚
â”‚  Query: SELECT * FROM transactions                           â”‚
â”‚         WHERE user_id = '550e8400-...'                      â”‚
â”‚           AND transaction_date >= '2025-01-01'              â”‚
â”‚           AND transaction_date < '2025-02-01'               â”‚
â”‚                                                                 â”‚
â”‚  Plan: INDEX SCAN idx_transactions_user_date               â”‚
â”‚        â”œâ”€ Start: (550e8400, 2025-01-01)                    â”‚
â”‚        â”œâ”€ End:   (550e8400, 2025-01-31)                    â”‚
â”‚        â””â”€ Return: 50 rows in ~5ms                          â”‚
â”‚                                                                 â”‚
â”‚  Sin Ã­ndice: FULL TABLE SCAN (1M rows) = 500ms  âŒ         â”‚
â”‚  Con Ã­ndice: RANGE SCAN (50 rows) = 5ms        âœ…          â”‚
â”‚  Speedup: 100x mÃ¡s rÃ¡pido!                                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Flujo de AuditorÃ­a AutomÃ¡tica

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               AUDITORÃA AUTOMÃTICA CON TRIGGERS                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Escenario: Usuario modifica una transacciÃ³n                   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€ CÃ³digo C#                                                  â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”‚  var transaction = await _repo.GetAsync(userId, transId);  â”‚
â”‚  â”‚  transaction.Amount = 250.00;  â† Cambio                    â”‚
â”‚  â”‚  transaction.Status = "COMPLETED";                         â”‚
â”‚  â”‚  await _repo.SaveAsync(transaction);                       â”‚
â”‚  â”‚                                                              â”‚
â”‚  â””â”€ EF Core genera:                                            â”‚
â”‚     UPDATE transactions.transactions                           â”‚
â”‚     SET amount = 250.00,                                       â”‚
â”‚         status = 'COMPLETED',                                  â”‚
â”‚         updated_at = NOW()                                     â”‚
â”‚     WHERE id = '770e8400-...'                                 â”‚
â”‚                                                                  â”‚
â”‚     â†“ TRIGGER: tr_transactions_audit_update (BEFORE UPDATE)   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€ FunciÃ³n PL/pgSQL detecta cambios                          â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”‚  IF OLD.amount IS DISTINCT FROM NEW.amount THEN            â”‚
â”‚  â”‚      changed_fields[] := changed_fields[] || 'amount'      â”‚
â”‚  â”‚  END IF;                                                    â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”‚  IF OLD.status IS DISTINCT FROM NEW.status THEN            â”‚
â”‚  â”‚      changed_fields[] := changed_fields[] || 'status'      â”‚
â”‚  â”‚  END IF;                                                    â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”‚  -- Construir old_values JSONB                             â”‚
â”‚  â”‚  old_values := jsonb_build_object(                         â”‚
â”‚  â”‚      'amount', OLD.amount,                                 â”‚
â”‚  â”‚      'status', OLD.status                                  â”‚
â”‚  â”‚  );                                                         â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”‚  -- Construir new_values JSONB                             â”‚
â”‚  â”‚  new_values := jsonb_build_object(                         â”‚
â”‚  â”‚      'amount', NEW.amount,                                 â”‚
â”‚  â”‚      'status', NEW.status                                  â”‚
â”‚  â”‚  );                                                         â”‚
â”‚  â”‚                                                              â”‚
â”‚  â””â”€ INSERT en audit_logs (AUTOMÃTICO):                        â”‚
â”‚     INSERT INTO audit_logs (                                   â”‚
â”‚         user_id, transaction_id, action,                      â”‚
â”‚         old_values, new_values, changed_fields                â”‚
â”‚     ) VALUES (                                                 â”‚
â”‚         '550e8400-...', '770e8400-...', 'UPDATE',            â”‚
â”‚         '{"amount": 200, "status": "PENDING"}',              â”‚
â”‚         '{"amount": 250, "status": "COMPLETED"}',            â”‚
â”‚         '{"amount", "status"}'                                â”‚
â”‚     );                                                         â”‚
â”‚                                                                  â”‚
â”‚  âœ… GARANTIZADO:                                              â”‚
â”‚     â”œâ”€ AuditorÃ­a automÃ¡tica (no puede olvidarse)             â”‚
â”‚     â”œâ”€ JSONB preserva exactamente quÃ© cambiÃ³                 â”‚
â”‚     â”œâ”€ Immutable (INSERT ONLY en audit_logs)                 â”‚
â”‚     â”œâ”€ Compliance: Prueba de cambios para auditorÃ­a          â”‚
â”‚     â””â”€ Recuperable: Restore a estado anterior                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ Soft Delete Pattern

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SOFT DELETE STRATEGY                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Problema: Â¿QuÃ© pasa cuando un usuario elimina una transacciÃ³n?   â”‚
â”‚                                                                     â”‚
â”‚  OpciÃ³n 1: Hard Delete (âŒ MAL)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  DELETE FROM transactions WHERE id = '770e8400-...';         â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  Consecuencias:                                             â”‚ â”‚
â”‚  â”‚  â”œâ”€ Se pierde completamente el registro                     â”‚ â”‚
â”‚  â”‚  â”œâ”€ No hay forma de recuperar datos                         â”‚ â”‚
â”‚  â”‚  â”œâ”€ Viola auditorÃ­a (cumplimiento)                          â”‚ â”‚
â”‚  â”‚  â”œâ”€ Cascade deletes afectan relaciones                      â”‚ â”‚
â”‚  â”‚  â””â”€ Imposible hacer "undo"                                  â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚  OpciÃ³n 2: Soft Delete (âœ… CORRECTO)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  UPDATE transactions                                         â”‚ â”‚
â”‚  â”‚  SET deleted_at = CURRENT_TIMESTAMP  â† Marcar, no eliminar  â”‚ â”‚
â”‚  â”‚  WHERE id = '770e8400-...';                                 â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  Estado en BD:                                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ id            | amount | status     | deleted_at     â”‚  â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚ â”‚
â”‚  â”‚  â”‚ 770e8400-... â”‚ 250.00 â”‚ COMPLETED  | 2025-01-20... â”‚  â”‚ â”‚
â”‚  â”‚  â”‚              â”‚        â”‚            â”‚ (se marcÃ³)    â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  En todas las queries:                                      â”‚ â”‚
â”‚  â”‚  SELECT * FROM transactions                                â”‚ â”‚
â”‚  â”‚  WHERE user_id = '550e8400-...'                            â”‚ â”‚
â”‚  â”‚    AND deleted_at IS NULL  â† SIEMPRE FILTRAR              â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  Ventajas:                                                  â”‚ â”‚
â”‚  â”‚  â”œâ”€ AuditorÃ­a completa (datos histÃ³ricos preservados)      â”‚ â”‚
â”‚  â”‚  â”œâ”€ Recuperable: UPDATE ... SET deleted_at = NULL         â”‚ â”‚
â”‚  â”‚  â”œâ”€ Compliance: Prueba de eliminaciÃ³n en audit_logs        â”‚ â”‚
â”‚  â”‚  â”œâ”€ Sin cascade deletes (datos aislados)                   â”‚ â”‚
â”‚  â”‚  â”œâ”€ FÃ¡cil "undo" para usuarios                             â”‚ â”‚
â”‚  â”‚  â””â”€ Performance: Solo marcar, no reorganizar Ã­ndices       â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚  Timeline:                                                         â”‚
â”‚                                                                     â”‚
â”‚  2025-01-15 10:30 - Usuario crea transacciÃ³n                     â”‚
â”‚  2025-01-15 11:00 - Usuario edita monto (audit log)             â”‚
â”‚  2025-01-15 14:30 - Usuario elimina (soft delete)               â”‚
â”‚  2025-01-15 15:00 - Admin ve en audit_logs quÃ© pasÃ³             â”‚
â”‚  2025-01-15 15:30 - Admin restaura con UPDATE ... deleted_at    â”‚
â”‚  2025-01-16 10:00 - Limpieza automÃ¡tica si > 365 dÃ­as          â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ Escalabilidad

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 PLAN DE ESCALABILIDAD                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Hoy (Desarrollo)                                              â”‚
â”‚  â”œâ”€ 1 Base de Datos PostgreSQL                               â”‚
â”‚  â”œâ”€ Schema separados (auth, transactions)                    â”‚
â”‚  â”œâ”€ ~100,000 transacciones                                    â”‚
â”‚  â””â”€ 1,000 usuarios activos                                    â”‚
â”‚                                                                 â”‚
â”‚  MaÃ±ana (ProducciÃ³n)                                          â”‚
â”‚  â”œâ”€ PostgreSQL con Read Replicas (si > 1,000 QPS)            â”‚
â”‚  â”‚  â”œâ”€ Primary: Write transactions                            â”‚
â”‚  â”‚  â”œâ”€ Replica 1: Read reports (analytics)                   â”‚
â”‚  â”‚  â””â”€ Replica 2: Read queries (backup)                      â”‚
â”‚  â”œâ”€ Cache layer (Redis) para queries frecuentes              â”‚
â”‚  â”‚  â”œâ”€ Cache: Active sessions (user_id â†’ tokens)            â”‚
â”‚  â”‚  â”œâ”€ Cache: User balance (user_id â†’ summary)              â”‚
â”‚  â”‚  â””â”€ Invalidate on transaction UPDATE                      â”‚
â”‚  â””â”€ Backup diario + WAL archiving                            â”‚
â”‚                                                                 â”‚
â”‚  Futuro (Escala Masiva)                                       â”‚
â”‚  â”œâ”€ Sharding por user_id (si > 10 millones de usuarios)      â”‚
â”‚  â”‚  â”œâ”€ Shard 1: user_id % 4 = 0                             â”‚
â”‚  â”‚  â”œâ”€ Shard 2: user_id % 4 = 1                             â”‚
â”‚  â”‚  â”œâ”€ Shard 3: user_id % 4 = 2                             â”‚
â”‚  â”‚  â””â”€ Shard 4: user_id % 4 = 3                             â”‚
â”‚  â”‚                                                             â”‚
â”‚  â”œâ”€ Partitioning by month (si audit_logs > 1 TB)            â”‚
â”‚  â”‚  â”œâ”€ Jan 2025 partition                                    â”‚
â”‚  â”‚  â”œâ”€ Feb 2025 partition                                    â”‚
â”‚  â”‚  â””â”€ ... (auto-partition con triggers)                     â”‚
â”‚  â”‚                                                             â”‚
â”‚  â”œâ”€ Archival: Move old data to cold storage                  â”‚
â”‚  â”‚  â”œâ”€ audit_logs > 2 aÃ±os â†’ S3 (compliance)                â”‚
â”‚  â”‚  â””â”€ deleted_at records â†’ Archive DB                       â”‚
â”‚  â”‚                                                             â”‚
â”‚  â””â”€ Microservices: Report Service (separate)                 â”‚
â”‚     â””â”€ Reads from Replica DB (no impact on Primary)          â”‚
â”‚                                                                 â”‚
â”‚  El schema actual SOPORTA todo esto sin cambios! âœ…           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Checklist de VerificaciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            VERIFICACIÃ“N POST-IMPLEMENTACIÃ“N                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  âœ… BASE DE DATOS                                               â”‚
â”‚     âœ“ PostgreSQL 12+ instalado                                  â”‚
â”‚     âœ“ ExtensiÃ³n uuid-ossp creada                               â”‚
â”‚     âœ“ BD: finansecure_auth_db_dev creada                       â”‚
â”‚     âœ“ BD: finansecure_transactions_db_dev creada               â”‚
â”‚     âœ“ Schema: auth creado                                       â”‚
â”‚     âœ“ Schema: transactions creado                              â”‚
â”‚                                                                   â”‚
â”‚  âœ… TABLAS AUTH SERVICE                                         â”‚
â”‚     âœ“ users (11 columnas)                                       â”‚
â”‚     âœ“ refresh_tokens (8 columnas)                              â”‚
â”‚     âœ“ 9 Ã­ndices creados                                         â”‚
â”‚     âœ“ 2 vistas creadas                                          â”‚
â”‚     âœ“ 2 funciones creadas                                       â”‚
â”‚     âœ“ 1 trigger creado                                          â”‚
â”‚                                                                   â”‚
â”‚  âœ… TABLAS TRANSACTIONS SERVICE                                â”‚
â”‚     âœ“ categories (9 columnas)                                   â”‚
â”‚     âœ“ transactions (13 columnas)                               â”‚
â”‚     âœ“ audit_logs (9 columnas, JSONB)                          â”‚
â”‚     âœ“ budgets (8 columnas)                                      â”‚
â”‚     âœ“ 14 Ã­ndices creados                                        â”‚
â”‚     âœ“ 3 ENUM types creados                                      â”‚
â”‚     âœ“ 2 vistas creadas                                          â”‚
â”‚     âœ“ 4 funciones creadas                                       â”‚
â”‚     âœ“ 5 triggers creados                                        â”‚
â”‚                                                                   â”‚
â”‚  âœ… SEGURIDAD                                                   â”‚
â”‚     âœ“ user_id en todas las tablas de transacciones            â”‚
â”‚     âœ“ deleted_at para soft deletes                             â”‚
â”‚     âœ“ audit_logs append-only (insert only)                    â”‚
â”‚     âœ“ JSONB para flexibilidad                                  â”‚
â”‚     âœ“ Ãndices en claves de bÃºsqueda                           â”‚
â”‚                                                                   â”‚
â”‚  âœ… PERFORMANCE                                                 â”‚
â”‚     âœ“ Ãndice compuesto (user_id, date) en transactions        â”‚
â”‚     âœ“ Ãndices parciales para activos                           â”‚
â”‚     âœ“ UNIQUE indexes para constraints                          â”‚
â”‚     âœ“ GIN indexes para JSONB                                   â”‚
â”‚                                                                   â”‚
â”‚  âœ… AUTOMATIZACIÃ“N                                              â”‚
â”‚     âœ“ Triggers actualizan updated_at automÃ¡ticamente          â”‚
â”‚     âœ“ Triggers crean audit logs automÃ¡ticamente               â”‚
â”‚     âœ“ Funciones para limpieza                                  â”‚
â”‚     âœ“ Funciones para anÃ¡lisis                                  â”‚
â”‚                                                                   â”‚
â”‚  âœ… DOCUMENTACIÃ“N                                               â”‚
â”‚     âœ“ DATABASE_ARCHITECTURE.md - Conceptos                     â”‚
â”‚     âœ“ DATABASE_SETUP_GUIDE.md - InstalaciÃ³n                   â”‚
â”‚     âœ“ DATABASE_INDEX.md - NavegaciÃ³n                          â”‚
â”‚     âœ“ DATABASE_QUERIES.md - Queries Ãºtiles                    â”‚
â”‚     âœ“ Comments en SQL (COMMENT ON)                             â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Contacto y Soporte

**Problemas de conexiÃ³n:**
â†’ Ver DATABASE_SETUP_GUIDE.md â†’ Troubleshooting

**Preguntas sobre design:**
â†’ Ver DATABASE_ARCHITECTURE.md â†’ Mejores PrÃ¡cticas

**Queries SQL Ãºtiles:**
â†’ Ver DATABASE_QUERIES.md

**NavegaciÃ³n:**
â†’ Ver DATABASE_INDEX.md

---

**Ãšltima actualizaciÃ³n:** 2025-01-20  
**VersiÃ³n:** 1.0  
**Status:** âœ… Completo

